---
title: "Drift_QAQC"
author: "Catarina Pien"
date: "September 18, 2020"
output: html_document
editor_options: 
  chunk_output_type: console
---
YBFMP Drift Invertebrate Data 1998 - 2019


```{r set-options, echo=FALSE, cache=FALSE}

options(width = 10000)
```

## Setup 

1.Setup and Download Libraries

```{r setup, results=FALSE, warning = FALSE, message = FALSE}

rm(list=ls(all=TRUE))

library(tidyverse)
library(gridExtra) # combine plots
library(stringr)
library(readr)
library(lubridate)
library(plotly)
library(viridis)
```

2.Load Data, Check Variable Types

```{r load, results = FALSE, warning = FALSE, message = FALSE}
# Load data - several tables
phys <- read_csv("Data/Drift/LT_phys_qc_20201125.csv")
catch <- read_csv("Data/Drift/Drift_Catch_20200918.csv")
samp <- read_csv("Data/Drift/Drift_Samplings_20200918.csv")
tax <- read_csv("Data/Drift/Drift_Taxonomy.csv")
wy <- read_csv("Data/WaterYearType_CDEC.csv") 
#inv_tax_2 <- read_csv("Data/TblInvertsLookUpV2.csv")

# Add and change date formats
phys$Date<-as.Date(phys$Date,"%m/%d/%Y")
phys$Year <- year(phys$Date)
phys$Month <- month(phys$Date)
phys$MonthAbb <-ordered(phys$Month,levels=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))
phys$Datetime = as.POSIXct(phys$Datetime, 
                           format = "%Y-%m-%d %H:%M:%S")
catch$Time <- as.POSIXct(catch$Time,
                         format = "%m/%d/%Y %H:%M")
# Add and change date formats
samp$Date<-as.Date(samp$Date,"%m/%d/%Y")
samp$`Date/Time` = as.POSIXct(samp$`Date/Time`, 
                           format = "%m/%d/%Y %H:%M:%S")

str(phys)
str(catch)
```

3.Rename variables
```{r filter, results = FALSE, message = FALSE, warning = FALSE}
catch <- catch %>%
  mutate(SamplingID = str_extract(`Sampling number`, "[^/]+")) %>%
  rename(Datetime = Time,
         TaxonName = Observable,
         LifeStage = `Life Stage`) %>%
  select(-c(Value, `Sampling number`))
catch$SamplingID = as.numeric(catch$SamplingID)

samp <- samp %>% 
  rename(SamplingID = `Sampling number`,
         Datetime = `Date/Time`,
         InvertDataID = `Invertebrate Data ID`,
         ConditionCode = `Condition Code`,
         SetTime = `Set Time`,
         FlowMeterSpeed = `Flow Meter Speed`,
         FlowMeterStart = `Flow Meter Start`,
         FlowMeterEnd = `Flow Meter End`,
         LabComments = `Lab Comments`,
         FieldComments = `Field Comments`) %>%
  select(-`Invertebrate Catch ID`)
samp$SamplingID <- as.numeric(samp$SamplingID)
summary(samp)
```

4. Make changes already identified
```{r}

```


5. Merge data tables, calculate Flowmeter difference, rearrange variables
```{r merge, message = FALSE, warning = FALSE}
# Merge datasets for CPUE variables
# tax <- full_join(inv_tax, inv_tax_2, by = "OrganismID")
samp_catch <- left_join(samp, catch, by = c("SamplingID")) %>%
  rename(Station = Station.x,
         Datetime = Datetime.x) %>%
  select(-c(Station.y, Datetime.y))

# Merge physical data
samp_catch_phys <- left_join(phys, samp_catch, by = "PhysicalDataID") %>%
  rename(Date = Date.x,
         Time = Time.x,
         Datetime = Datetime.x) %>%
  select(-c(Date.y, Time.y, Datetime.y)) %>%
  filter(!is.na(Station)) 
notjoinedPhysDataID <- anti_join(phys, samp_catch, by = "PhysicalDataID")

```

Add Water Year and Water Year "Class" (W = W, D/C = D, AN/BN = A), calculate Flowdiff
```{r}
samp_catch_phys <- samp_catch_phys %>%
  mutate(WY = ifelse(Month >9, Year + 1, Year)) %>%
  left_join(wy, by = "WY") %>%
  select(-c(WYType, Index)) %>%
  mutate(Flowdiff = FlowMeterEnd-FlowMeterStart)
```

## QAQC 

* QC Flags: Blank = no issues/1 = Comment but deemed Acceptable/ 2 = Suspect/ 3 = Highly Suspect
* Flag_SAMP: Sampling issues
* Flag_LAB: Lab issues
* Flag_FM: Flowmeter
* Flag_CPUE: CPUE

### QAQC Sampling and Lab issues

6. Export sampling table
7. Look at field sampling comments
8. Flag comments reflecting poor data quality (Flag_SAMP)
9. Add comment about what was flagged
    * FMMISSING if lacking flowmeter values
    * SAMP for other sampling issues 
    * Leave blank if no issues
10. Look at lab comments and flag if poor data quality
11. Add Comment_LAB
    * LAB if lab issues (e.g. unable to meet meso or microtally)
    * Leave blank if no issues

* This part is manual. Think about how to make this codeable, change our condition code flags or add a flag as part of data entry? 

```{r}
SamplingQAQC <- filter(samp, !is.na(FieldComments) | ConditionCode>1)
SamplingQAQC$Flag_SAMP <-  ""
SamplingQAQC$Comment_SAMP <-""
SamplingQAQC$Flag_LAB <- ""
SamplingQAQC$Comment_LAB <- ""
# write.csv(SamplingQAQC, "R_write/Drift/SamplingQAQC.csv")

```

12. Read edited file in

```{r}
SamplingQAQC_fill <- read.csv("R_write/Drift/SamplingQAQC_Notated_20210112.csv")
SamplingQAQC_fill_s <- SamplingQAQC_fill %>%
  select(c(PhysicalDataID, Flag_SAMP, Comment_SAMP, Flag_LAB, Comment_LAB))
```


### QAQC Flowmeters

Should we use inundation for value replacement? 
```{r}
Inundation <- read.csv("Data/InundationWY2010toWY2019.csv")
Inundation$Date <- mdy(Inundation$Date)
Inundation <- Inundation %>%
  mutate(Month = month(Date),
         Year = year(Date),
         WY = ifelse(Month > 9, Year + 1, Year))

samp2 <-samp %>%
  mutate(Flowdiff = FlowMeterEnd-FlowMeterStart)

Inundation_flow <- left_join(samp2, Inundation, by = "Date") %>%
  filter(Date>"2010-01-01") %>%
  filter(Flowdiff<100000) %>%
  filter(Station == "STTD") %>%
  mutate(Inundation_n = ifelse(Inundation == "TRUE", 30000, 0))

inplot <- ggplot(Inundation_flow) + 
  geom_point(aes(x = Date, y = Flowdiff)) + 
  geom_col(aes(x = Date, y = Inundation_n), fill = "blue", size = 2) + 
  facet_grid(Station~.) +
  theme_bw()

Inundation2 <- Inundation %>%
  mutate(Inundation_n = ifelse(Inundation == "TRUE", 30000, 0))

inplot2 <- ggplot() +
  geom_point(data = Inundation_flow, aes(x = Date, y = Flowdiff)) +
  geom_col(data = Inundation2, aes(x = Date, y = Inundation_n), fill = 
                 "blue", alpha = 0.6) + theme_bw()
inplot
inplot2  
ggplotly(inplot2)

Inundation3 <- Inundation %>%
  mutate(Month = month(Date),
         Year = year(Date)) %>%
  filter(Inundation == "TRUE") %>%
  group_by(WY) %>%
  mutate(first = ymd(first(Date)),
            last = ymd(last(Date))) %>%
  ungroup() %>%
  select(c(WY, first, last))

Inundation4 <- left_join(Inundation, Inundation3, by = c("WY")) %>%
  mutate(Inundation_pd = ifelse(WY < 2010, "NA", ifelse(Date >= first & Date <= last, "Yes", "No")))

```






13. Look at distribution of flowmeter values
```{r}
# Histogram of values
samp_catch_phys$Month <- ordered(samp_catch_phys$Month)
FlowHist <- ggplot(samp_catch_phys, aes(Flowdiff)) + geom_histogram() +
  facet_wrap(~Station) + theme_bw()
ggplotly(FlowHist)

# SHR vs STTD boxplot
FlowBox <- ggplot(samp_catch_phys) + geom_boxplot(aes(x = Station, y = Flowdiff)) + theme_bw()
ggplotly(FlowBox)

# SHR vs STTD boxplot by month
FlowBoxMonth <- ggplot(samp_catch_phys) + geom_boxplot(aes(x = Month, y = Flowdiff, fill = Month)) + facet_wrap(~Station) + scale_fill_viridis(discrete = TRUE) + theme_bw() 
ggplotly(FlowBoxMonth)

# SHR vs STTD boxplot by year
FlowBoxYear <- ggplot(samp_catch_phys) + geom_boxplot(aes(x = ordered(WY), y = Flowdiff, fill = ordered(WY))) + facet_wrap(~Station) + theme_bw() 
ggplotly(FlowBoxYear)

# SetTime vs Flowdiff by station and month
FlowPoint <- ggplot(samp_catch_phys, aes(x = SetTime, y = Flowdiff, color = Month)) + geom_point() + facet_wrap(~Station) + theme_bw()
ggplotly(FlowPoint)

# SetTime vs Flowdiff by station and flowmeter type
FlowPoint2 <- ggplot(samp_catch_phys, aes(x = SetTime, y = Flowdiff, color = FlowMeterSpeed)) + geom_point() + facet_wrap(~Station) + theme_bw()
ggplotly(FlowPoint2)
```

14. Change obvious flowmeter values
```{r QAQC-Flowmeters}
library(plotly)
library(viridis)

# Change known incorrect values
# Change FlowMeterStart and FlowMeterEnd, Recalculate Flowdiff
# SamplingID = 47736 Switched FlowMeterStart and FlowMeterEnd 
samp_catch_phys$FlowMeterStart[samp_catch_phys$SamplingID==47736] <- 573926
samp_catch_phys$FlowMeterEnd[samp_catch_phys$SamplingID==47736] <- 581200
samp_catch_phys$Flowdiff[samp_catch_phys$SamplingID==47736] <- 581200-573926

```

15. Merge data with lab/sampling QAQC 
    * Replace NA with blank
```{r}
FM_Samp <- left_join(samp_catch_phys, SamplingQAQC_fill_s, by = "PhysicalDataID") %>%
  mutate(Flag_SAMP = replace(Flag_SAMP, is.na(Flag_SAMP), "" ),
         Comment_SAMP = replace(Comment_SAMP, is.na(Comment_SAMP), ""),
         Flag_LAB = replace(Flag_LAB, is.na(Flag_LAB), ""),
         Comment_LAB = replace(Comment_LAB, is.na(Comment_LAB), ""))
```

16. Make a table of summarized flowmeter values
    * Use Flowdiff/Settime to look for outliers
```{r}
### Table of values
# Calculate median, lower and upper ranges for each day
Flow.sum <- samp_catch_phys %>%
  mutate(Flow_s = Flowdiff/SetTime) %>%
  group_by(StationCode, FlowMeterSpeed, WYClass) %>%
  filter(!is.na(Flowdiff)) %>%
  summarize(min.Flowdiff = min(Flowdiff),
            max.Flowdiff = max(Flowdiff),
            median.Flowdiff = median(Flowdiff),
            Flow_Q1 = quantile(Flowdiff, probs = 0.25),
            Flow_Q3 = quantile(Flowdiff, probs = 0.75),
            Flow_UL = Flow_Q3 + 1.5 * (Flow_Q3-Flow_Q1),
            Flow_s_Q1 = quantile(Flow_s, probs = 0.25), 
            Flow_s_Q3 = quantile(Flow_s, probs = 0.75),
            Flow_s_UL = Flow_Q3 + 1.5 * (Flow_s_Q3-Flow_s_Q1),
            Flow_s_MAD = mad(Flow_s))
```

17. Apply outlier definitions to data
```{r}
Flow.outlier1 <- FM_Samp %>%
  filter(!is.na(Flowdiff)) %>%
  group_by(StationCode, FlowMeterSpeed, WYClass) %>%
  mutate(Flow_s = Flowdiff/SetTime,
         median.Flow_s = median(Flow_s),
            Flow_Q1 = quantile(Flow_s, probs = 0.25), 
            Flow_Q3 = quantile(Flow_s, probs = 0.75),
            Flow_UL = Flow_Q3 + 1.5 * (Flow_Q3-Flow_Q1),
            Flow_MAD = mad(Flow_s),
            Flow_modZ = abs(0.6745*(Flow_s - median.Flow_s)/Flow_MAD),
            Flow_Outlier = ifelse((Flow_s > Flow_UL) & Flow_modZ > 3.5, "Both", ifelse(Flow_s > Flow_UL, "Tukey", ifelse(Flow_modZ > 3.5, "MAD", 
            "None"))))

summary(factor(Flow.outlier1$Flow_Outlier))

```

18. Plot outliers
```{r}

FlowBoxMonth <- ggplot(Flow.outlier1) + geom_boxplot(aes(x = WYClass, y = Flow_s)) + facet_wrap(~Station) + scale_fill_viridis(discrete = TRUE) + theme_bw() 
ggplotly(FlowBoxMonth)


outlierWY <- ggplot(Flow.outlier1, aes(x = WYClass, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) + facet_wrap(~Station) +   
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

ggplotly(outlierWY)

outlierMonth <- ggplot(Flow.outlier1, aes(x = Month, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) + facet_wrap(~Station) +   
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

ggplotly(outlierMonth)
```

This is looking at whether Month grouping helps
```{r}
Flow.outlier2 <- FM_Samp %>%
  filter(!is.na(Flowdiff)) %>%
  group_by(StationCode, FlowMeterSpeed, WYClass, Month) %>%
  mutate(Flow_s = Flowdiff/SetTime,
         median.Flow_s = median(Flow_s),
            Flow_Q1 = quantile(Flow_s, probs = 0.25), 
            Flow_Q3 = quantile(Flow_s, probs = 0.75),
            Flow_UL = Flow_Q3 + 1.5 * (Flow_Q3-Flow_Q1),
            Flow_MAD = mad(Flow_s),
            Flow_modZ = abs(0.6745*(Flow_s - median.Flow_s)/Flow_MAD),
            Flow_Outlier = ifelse((Flow_s > Flow_UL) & Flow_modZ > 3.5, "Both", ifelse(Flow_s > Flow_UL, "Tukey", ifelse(Flow_modZ > 3.5, "MAD", 
            "None"))))

summary(factor(Flow.outlier2$Flow_Outlier))


```

Plot outliers
```{r}

FlowBoxMonth2 <- ggplot(Flow.outlier2) + geom_boxplot(aes(x = WYClass, y = Flow_s)) + facet_wrap(~Station) + scale_fill_viridis(discrete = TRUE) + theme_bw() 
ggplotly(FlowBoxMonth)


outlierWY2 <- ggplot(Flow.outlier2, aes(x = WYClass, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) + facet_wrap(~Station) +   
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

ggplotly(outlierWY2)


outlierMonth2 <- ggplot(Flow.outlier2, aes(x = Month, y = Flow_s, color = Flow_Outlier)) + geom_point(size = 2.5, alpha = 0.5) + facet_wrap(~Station) +   
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

ggplotly(outlierMonth2)
```

**Looks better not using Month (Flow.outlier1)**

19. Flowmeter Flags and New Flowdiff calculated


Flag   | Description                | Outlier                   | Flowdiff
Flag 3 | Highly Suspect             | Both                      | < 200 or >= 60000
Flag 2 | Suspect                    | Tukey or MAD but not Both | 200-999 
Flag 1 | Acceptable                 |                           | 
No flag| Acceptable                 | None                      | 1000-59999

20. Add comment about what was flagged (FM for flowmeter-related)
21. Calculate replacement values where Flag_FM = 3 or Comment_SAMP = FM
  * Replacement values are median standardized flowdiff * settime based on groupings of Station, Flowmeter Speed, Water Year Class

```{r Flag-Replace-Flowmeters}
################## Flag Flowmeter data: Flag_QC1 ############################
# Mutate QC Flags 
# Conditions for Flag 3: Outlier = Both | Flowdiff < 200 | Flowdiff >= 60000
# Conditions for Flag 2: Outlier = Tukey | Outlier = MAD (but not Both) |Flowdiff between 200-999 
# Conditions for Flag 1: Acceptable data

# If Flag 3, replace Flowdiff with median.Flowdiff and replace Flag_FM as 5

FlowmeterQAQC <- Flow.outlier1 %>%
  mutate(Flag_FM = ifelse(Flow_Outlier=="Both" | Flowdiff < 200 | Flowdiff >= 60000, 3, 
                          ifelse(Flow_Outlier %in% c("Tukey", "MAD") | Flowdiff < 1000, 2,
                                 "")),
           Comment_FM = ifelse(Flag_FM %in% c(2,3), "FM", ""),
        Flowdiff_adj = ifelse(Flag_FM == 3 | Comment_SAMP == "FM", median.Flow_s * SetTime, Flowdiff))
```


Summarize number of outliers flagged
```{r}
FlowmeterQAQC$Flag_FM <- ordered(FlowmeterQAQC$Flag_FM)

summary(factor(FlowmeterQAQC$Flag_FM))
summary(factor(FlowmeterQAQC$Flag_SAMP))
summary(factor(FlowmeterQAQC$Flag_LAB))
```

22. Plot changes and flags
```{r}

outlierPreFlow <- ggplot(FlowmeterQAQC, aes(x = factor(Month), y = Flowdiff, color = factor(Flag_FM))) + geom_point(size = 2.5, alpha = 0.5) +  scale_color_viridis(discrete = TRUE) + labs(title = "Flowmeter Pre-QC") +
  facet_wrap(~Station) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

outlierPostFlow <- ggplot(FlowmeterQAQC, aes(x = factor(Month), y = Flowdiff_adj, color = factor(Flag_FM))) + geom_point(size = 2.5, alpha = 0.5) + scale_color_viridis(discrete = TRUE)  + labs(title = "Flowmeter Post-QC") +
  facet_wrap(~Station) +   
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

grid.arrange(outlierPreFlow, outlierPostFlow, nrow = 2)
```

Plot before and after for SAMP
```{r}
outlierPreSamp <- ggplot(Flow.outlier1, aes(x = factor(Month), y = Flowdiff, color = factor(Flag_SAMP))) + geom_point(size = 3, alpha = 0.8) + scale_color_viridis(discrete = TRUE) + labs(title = "Sampling Pre-QC") +
  facet_wrap(~Station) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

outlierPostSamp <- ggplot(FlowmeterQAQC, aes(x = factor(Month), y = Flowdiff_adj, color = factor(Flag_SAMP))) + geom_point(size = 3, alpha = 0.8) + scale_color_viridis(discrete = TRUE) + labs(title = "Sampling Post-QC") +
  facet_wrap(~Station) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

grid.arrange(outlierPreSamp, outlierPostSamp, nrow = 2)
```


## QAQC: CPUE

24. Calculate Vol and CPUE, Vol_adj, CPUE_adj

```{r}
NetArea = 0.4572 * 0.25
FlowQAQC_CPUE <- FlowmeterQAQC %>%
  mutate(Volume = ifelse(FlowMeterSpeed == "Regular",
                         Flowdiff * 26873 * NetArea/999999,
                         ifelse(FlowMeterSpeed == "Low",
                                Flowdiff * 57560 * NetArea/999999, NA))) %>%
  filter(!is.na(Flowdiff)) %>%
  mutate(CPUE= round(Count/Volume,3))%>%
    
  mutate(Volume_adj = ifelse(FlowMeterSpeed == "Regular",
                         Flowdiff_adj * 26873 * NetArea/999999,
                         ifelse(FlowMeterSpeed == "Low",
                                Flowdiff_adj * 57560 * NetArea/999999, NA))) %>%
  mutate(CPUE_adj = round(Count/Volume_adj,3))%>%
  arrange(Datetime)

```

25. Look at distribution of CPUE values
```{r}
FlowQAQC_CPUE$Month <- factor(FlowQAQC_CPUE$Month)
FlowQAQC_low <- filter(FlowQAQC_CPUE, CPUE < 10)
FlowQAQC_high <- filter(FlowQAQC_CPUE, CPUE > 10)

# Histogram of values
CPUEHist <- ggplot(FlowQAQC_CPUE, aes(CPUE_adj)) + geom_histogram(binwidth = 1) +
  facet_wrap(~Station) + theme_bw()
ggplotly(CPUEHist)

CPUEHist2 <- ggplot(FlowQAQC_low, aes(CPUE_adj)) + geom_histogram(binwidth = .1) +
  facet_wrap(~Station) + theme_bw()
ggplotly(CPUEHist2)

CPUEHist3 <- ggplot(FlowQAQC_high, aes(CPUE_adj)) + geom_histogram(binwidth = 10) +
  facet_wrap(~Station) + theme_bw()
ggplotly(CPUEHist3)

# SHR vs STTD boxplot
CPUEBox <- ggplot(FlowQAQC_CPUE) + geom_boxplot(aes(x = Station, y = CPUE_adj)) + theme_bw()
ggplotly(CPUEBox)

# SHR vs STTD boxplot by month
CPUEBoxMonth <- ggplot(FlowQAQC_CPUE) + geom_boxplot(aes(x = Month, y = CPUE_adj, fill = Month)) + facet_wrap(~Station) + scale_fill_viridis(discrete = TRUE) + theme_bw() 
ggplotly(CPUEBoxMonth)

# SHR vs STTD boxplot by year
CPUEBoxYear <- ggplot(FlowQAQC_CPUE) + geom_boxplot(aes(x = factor(WY), y = CPUE_adj)) + facet_grid(Station~.) + theme_bw() 
ggplotly(CPUEBoxYear)

# SetTime vs CPUE by station and month
CPUEPoint <- ggplot(FlowQAQC_CPUE, aes(x = SetTime, y = CPUE, color = Month)) + geom_point() + facet_wrap(~Station) + theme_bw()
ggplotly(CPUEPoint)



```

CPUE and Count Plots
```{r}
# Species
inv_summary <-FlowQAQC_CPUE %>%
  filter(WY>1998) %>%
  group_by(Station, WYClass, TaxonName) %>%
  summarize(median.CPUE = median(CPUE_adj),
            max.CPUE = max(CPUE_adj),
            max.Count = max(Count),
            median.Count = median(Count),
            total.CPUE = sum(CPUE_adj),
            n = n()) %>%
  filter(n > 2)

# All CPUE
speciesCPUE <- ggplot(FlowQAQC_CPUE, aes(TaxonName, CPUE_adj)) + 
  geom_jitter(aes(col = WYClass)) + facet_grid(Station~.) + 
    theme_bw() + theme(axis.text = element_text(size = 12),
                      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))
ggplotly(speciesCPUE)


# Sum CPUE
species1 <- ggplot(inv_summary, aes(TaxonName, total.CPUE)) + 
  geom_jitter(aes(col = WYClass)) + facet_grid(Station~.) + 
    theme_bw() + theme(axis.text = element_text(size = 12),
                      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))
ggplotly(species1)

# Median CPUE
species2 <- ggplot(inv_summary, aes(TaxonName, median.CPUE)) + geom_jitter(aes(col = WYClass)) + facet_grid(Station~.) + 
    theme_bw() + theme(axis.text = element_text(size = 12),
                      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))
ggplotly(species2)

# MaxCPUE
species3 <- ggplot(inv_summary, aes(TaxonName, max.CPUE)) + geom_jitter(aes(col = WYClass)) + facet_grid(Station~.) + 
    theme_bw() + theme(axis.text = element_text(size = 12),
                      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))
ggplotly(species3)


# Median Count
medCount <- ggplot(inv_summary, aes(TaxonName, median.Count)) + geom_jitter(aes(col = WYClass)) + facet_grid(Station~.) + 
    theme_bw() + theme(axis.text = element_text(size = 12),
                      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))
ggplotly(medCount)

# Max Count
maxCount <- ggplot(inv_summary, aes(TaxonName, max.Count)) + geom_jitter(aes(col = WYClass)) + facet_grid(Station~.) + 
    theme_bw() + theme(axis.text = element_text(size = 12),
                      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))
ggplotly(maxCount)
```


26. Check on and change any known errors
```{r}
checkCounts <- filter(FlowQAQC_CPUE, Count>1000)
# Match up with datasheet 

checkCPUE <- filter(FlowQAQC_CPUE, CPUE_adj > 100)

```

27. Look at summary table of CPUE values
```{r}
### Table of values
CPUE.outlier <- FlowQAQC_CPUE %>%
  group_by(StationCode, FlowMeterSpeed, WYClass, TaxonName) %>%
  mutate(median.CPUE = median(CPUE_adj),
            CPUE_Q1 = quantile(CPUE_adj, probs = 0.1), 
            CPUE_Q3 = quantile(CPUE_adj, probs = 0.9),
            CPUE_UL = CPUE_Q3 + 1.5 * (CPUE_Q3-CPUE_Q1))

```

28. Determine and apply flags and cutoffs
    * In this case, used plots to decide to flag CPUE values > 70 

29. Add comment about what was flagged (Comment_CPUE = CPUE)
```{r}
CPUEQAQC <- CPUE.outlier %>%
  mutate(Flag_CPUE = ifelse(CPUE_adj>70, 2, "" ),
         Comment_CPUE = ifelse(CPUE_adj>70, "CPUE", ""))
```

30. Plot outliers
```{r}
outlier2b <- ggplot(CPUEQAQC, aes(x = Month, y = CPUE_adj, color = Flag_CPUE)) + geom_point(size = 2.5, alpha = 0.5) + scale_color_viridis(discrete = "TRUE") + facet_wrap(~Station) + 
  theme_bw() + theme(axis.text = element_text(size = 14),
                     axis.title = element_text(size =14),
                     legend.text = element_text(size = 14),
                     legend.title = element_text(size = 14), 
                     strip.text = element_text(size = 15))

ggplotly(outlier2b)

```

## Clean up display of dataset
31. Join taxa and clea up order of variables
```{r}

# Rename some columns, remove unnecessary columns
inv_select <- CPUEQAQC %>%
  select(c(Datetime, StationCode,
           WY, WYClass,
           WeatherCode, Tide, MicrocystisVisualRank,
           WaterTemperature:Turbidity,
           ConditionCode,FieldComments, 
           SetTime:FlowMeterEnd, Flowdiff, Flowdiff_adj, Volume,
           LabComments, 
           TaxonName:LifeStage, CPUE, CPUE_adj, 
           Flag_SAMP, Comment_SAMP, Flag_LAB, Comment_LAB, Flag_FM, Comment_FM, Flag_CPUE, Comment_CPUE)) 

inv_all <- left_join(inv_select, tax)
```

33. Merge flags and commments into one flag, one comment column
```{r}

inv_final <- inv_select %>%
  mutate(QC_Flags = paste(Flag_SAMP, ",", Flag_LAB, ",", Flag_FM, ",", Flag_CPUE)) %>%
  mutate(QC_Comments = paste(Comment_SAMP, ",", Comment_LAB, ",", Comment_CPUE))

## Filter rows with a 7
threes <- inv_final%>%
  filter(grepl("3", QC_Flags ))


```

34. Calculate proportion of data flagged
```{r}
## Amount replaced
print(paste0(round(nrow(threes)/nrow(inv_final)*100,3), "% highly suspicious"))
```

35. Write file

```{r}
# Write File
today = format(today(),"%Y%m%d")
write.csv(inv_final, paste0("R_write/Drift_data_", today, ".csv"), row.names = FALSE)
```

36. Write R-markdown file